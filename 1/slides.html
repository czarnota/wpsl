<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Procesy w systemie Linux</title>
    <style>
    html { -moz-text-size-adjust: none; -webkit-text-size-adjust: none; text-size-adjust: none; }
    * { box-sizing: border-box; }
    .level2, h1 { max-height: 92vh; margin: 1em auto; background: #fff;
                  font-size: 12px; aspect-ratio: 16 / 9; padding: 1.5em;
                  display: flex; flex-direction: column; overflow: hidden;
                  flex: 1 1 auto; box-shadow: 0 0 0.5em #ddd; color: #333; }
    h1 { align-items: center; flex-direction: row; padding: 0.75em; margin: 0.5em auto;}
    body { margin: 0; padding: 0; font-family: Helvetica, sans-serif;
           background: rgb(237, 237, 240); font-size: 200px; }
    h2 { font-size: 2em; color: #005; padding: 0; }
    img { display: block; margin: auto; width: 100%; height: 100%;
          overflow: hidden; object-fit: contain;}
    section > p, section > ul { line-height: 1.5em; }
    ul { padding-left: 1em; }
    h2 { margin: 0 0 0.4em 0; }
    pre { line-height: 1.125em; }

    @page { size: 16in 9in; margin: 0; }
    @media print {
        body { -webkit-print-color-adjust: exact; }
        .level2, h1 { max-height: 100vh; margin: 0; }
    }

    .language-console .gp { color: #6ec071; }
    .sourceCode.diff .st { color: #cc6666; }
    .sourceCode.diff .va { color: #b5bd68; }

    /*

        Name:       Base16 Tomorrow Dark
        Author:     Chris Kempson (http://chriskempson.com)

        Pygments template by Jan T. Sott (https://github.com/idleberg)
        Created with Base16 Builder by Chris Kempson (https://github.com/chriskempson/base16-builder)

    */
    .sourceCode .hll { background-color: #373b41; }
    .sourceCode { background: #1d1f21; color: #ffffff; }
    .sourceCode .co { color: #969896; } /* Comment */
    .sourceCode .err { color: #cc6666; }

    /* Error */
    .sourceCode .kw { color: #b294bb; } /* Keyword */
    .sourceCode .cf { color: #b294bb; } /* Keyword */
    .sourceCode .l { color: #de935f; }

    /* Literal */
    .sourceCode .n { color: #ffffff; }

    /* Name */
    .sourceCode .ot { color: #8abeb7; } /* Operator */
    .sourceCode .op { color: #8abeb7; } /* Operator */
    .sourceCode .p { color: #ffffff; }

    /* Punctuation */
    .sourceCode .cm { color: #969896; }

    /* Comment.Multiline */
    .sourceCode .pp { color: #69AE69; } /* Comment.Preproc */
    .sourceCode .im { color: #69AE69; } /* Comment.Preproc */
    .sourceCode .c1 { color: #969896; }

    /* Comment.Single */
    .sourceCode .cs { color: #969896; }

    /* Comment.Special */
    .sourceCode .gd { color: #cc6666; }

    /* Generic.Deleted */
    .sourceCode .ge { font-style: italic; }

    /* Generic.Emph */
    .sourceCode .gh { color: #ffffff; font-weight: bold; }

    /* Generic.Heading */
    .sourceCode .gi { color: #b5bd68; }

    /* Generic.Inserted */
    .sourceCode .gp { color: #969896; font-weight: bold; }

    /* Generic.Prompt */
    .sourceCode .gs { font-weight: bold; } 
    /* Generic.Strong */
    .sourceCode .gu { color: #8abeb7; font-weight: bold; }

    /* Generic.Subheading */
    .sourceCode .kc { color: #b294bb; }

    /* Keyword.Constant */
    .sourceCode .kd { color: #b294bb; }

    /* Keyword.Declaration */
    .sourceCode .kn { color: #8abeb7; }

    /* Keyword.Namespace */
    .sourceCode .kp { color: #b294bb; }

    /* Keyword.Pseudo */
    .sourceCode .kr { color: #b294bb; }

    /* Keyword.Reserved */
    .sourceCode .dt { color: #f0c674; } /* Keyword.Type */
    .sourceCode .ld { color: #b5bd68; }

    /* Literal.Date */
    .sourceCode .m { color: #de935f; }

    /* Literal.Number */
    .sourceCode .s { color: #b5bd68; }

    /* Literal.String */
    .sourceCode .na { color: #81a2be; }

    /* Name.Attribute */
    .sourceCode .bu { color: #ffffff; } /* Name.Builtin */
    .sourceCode .nc { color: #f0c674; }

    /* Name.Class */
    .sourceCode .no { color: #cc6666; }

    /* Name.Constant */
    .sourceCode .nd { color: #8abeb7; }

    /* Name.Decorator */
    .sourceCode .ni { color: #ffffff; }

    /* Name.Entity */
    .sourceCode .ne { color: #cc6666; }

    /* Name.Exception */
    .sourceCode .fu { color: #81a2be; } /* Name.Function */

    /* Name.Label */
    .sourceCode .nn { color: #f0c674; }

    /* Name.Namespace */
    .sourceCode .nx { color: #81a2be; }

    /* Name.Other */
    .sourceCode .py { color: #ffffff; }

    /* Name.Property */
    .sourceCode .nt { color: #8abeb7; }

    /* Name.Tag */
    .sourceCode .va { color: #cc6666; } /* Name.Variable */
    .sourceCode .ow { color: #8abeb7; }

    /* Operator.Word */
    .sourceCode .w { color: #ffffff; }

    /* Text.Whitespace */
    .sourceCode .mf { color: #de935f; }

    /* Literal.Number.Float */
    .sourceCode .mh { color: #de935f; }

    /* Literal.Number.Hex */
    .sourceCode .dv { color: #de935f; }

    /* Literal.Number.Integer */
    .sourceCode .mo { color: #de935f; }

    /* Literal.Number.Oct */
    .sourceCode .sb { color: #b5bd68; }

    /* Literal.String.Backtick */
    .sourceCode .sc { color: #ffffff; }

    /* Literal.String.Char */
    .sourceCode .sd { color: #969896; }

    /* x Literal.String.Doc */
    .sourceCode .st { color: #b5bd68; }

    /* Literal.String.Double */
    .sourceCode .sc { color: #de935f; } 
    /* Literal.String.Escape */
    .sourceCode .sh { color: #b5bd68; }

    /* Literal.String.Heredoc */
    .sourceCode .si { color: #de935f; }

    /* Literal.String.Interpol */
    .sourceCode .sx { color: #b5bd68; }

    /* Literal.String.Other */
    .sourceCode .sr { color: #b5bd68; }

    /* Literal.String.Regex */
    .sourceCode .s1 { color: #b5bd68; }

    /* Literal.String.Single */
    .sourceCode .ss { color: #b5bd68; }

    /* Literal.String.Symbol */
    .sourceCode .bp { color: #ffffff; }

    /* Name.Builtin.Pseudo */
    .sourceCode .vc { color: #cc6666; }

    /* Name.Variable.Class */
    .sourceCode .vg { color: #cc6666; }

    /* Name.Variable.Global */
    .sourceCode .vi { color: #cc6666; }

    /* Name.Variable.Instance */
    .sourceCode .il { color: #de935f; }

    /* Literal.Number.Integer.Long */

    div.sourceCode { vertical-align: top; }

    pre { font-family: monospace; font-size: 0.8em; }

    .sourceCode a { color: #fff }

    .sourceCode pre { padding: 0; margin: 0; }

    pre code { display: block; padding: 1em 1.25em; overflow-x: auto; background: #1d1f21; color: #ffffff; }

    .sourceCode pre code::-webkit-scrollbar { -webkit-appearance: none; }
    .sourceCode pre code::-webkit-scrollbar:vertical { width: 10px; }
    .sourceCode pre code::-webkit-scrollbar:horizontal { height: 10px; }
    .sourceCode pre code::-webkit-scrollbar-thumb { background-color: #555; }
    .sourceCode pre code::-webkit-scrollbar-track { background-color: #333; }
    .sourceCode::selection { background: #fff; /* WebKit/Blink Browsers */ color: #000; }
    .sourceCode::-moz-selection { background: #fff; /* Gecko Browsers */ color: #000; }
    p > code, li > code { background: #fff; padding: 0.1em 0.2em; box-shadow: 0 2px 4px 0 #ddd; border: 1px solid #ddd; }

    div.sourceCode, pre, section > p, section > ul { margin: 0 0 0.7em 0; }

    </style>
    <link rel="stylesheet" href="assets/styles.css" />
  </head>
  <body>
<section id="zagadnienie-1-procesy-w-systemie-linux" class="level1">
<h1>Zagadnienie 1: Procesy w systemie Linux</h1>
<section id="podstawowe-pojęcia" class="level2">
<h2>Podstawowe pojęcia</h2>
<ul class="incremental">
<li><strong>Program</strong> - sekwencja instrukcji wyrażonych w języku programowania, który komputer jest w stanie zinterpretować i wykonać.</li>
<li><strong>System operacyjny</strong> - program który tworzy środowisko do uruchamiania programów, zarządza dostępem procesu do zasobów sprzętowych,.</li>
<li><strong>Proces</strong> - kod który się wykonuje oraz ma przypisane zasoby</li>
<li><strong>Wątek</strong> - najmniejsza jednostka wykonywanego kodu, która może być zaplanowana przez planiste (ang. Scheduler).</li>
<li><strong>Procesor</strong> - układ scalony, który wykonuje instrukcje pobierane z pamięci operacyjnej.</li>
<li><strong>Wywołanie systemowe</strong> - przerwanie procesu i żądanie przez ten proces wykonania przez system operacyjny operacji uprzywilejowanej.</li>
</ul>
</section>
</section>
<section id="wielozadaniowość" class="level1">
<h1>Wielozadaniowość</h1>
<section id="co-to-jest-wielozadaniowość" class="level2">
<h2>Co to jest wielozadaniowość</h2>
<p>Wielozadaniowość oznacza, że system operacyjny może wykonywać wiele zadań jednocześnie. W przypadku maszyn jednoprocesorowych, system sprawia wrażenie wykonującego wiele zadań jednocześnie, a w rzeczywistości przydziela czas procesora na przemian kilku procesom.</p>
<p><img src="assets/8.svg" /></p>
</section>
<section id="wielozadaniowość-na-wielu-procesorachrdzeniach" class="level2">
<h2>Wielozadaniowość na wielu procesorach/rdzeniach</h2>
<p>W przypadku wielu procesorów, system operacyjny może uruchamiać procesy rzeczywiście równolegle</p>
<p><img src="assets/7.svg" /></p>
</section>
<section id="wielozadaniowość-na-wielu-procesorachrdzeniach-1" class="level2">
<h2>Wielozadaniowość na wielu procesorach/rdzeniach</h2>
<p>W praktyce procesy mogą być uruchamiane na różnych rdzeniach procesora.</p>
<p><img src="assets/9.svg" /></p>
</section>
<section id="afiniczność-procesora" class="level2">
<h2>Afiniczność procesora</h2>
<p>W Linuksie możemy określić na których procesorach będzie wykonywany proces</p>
<div class="sourceCode" id="cb1"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="ex">$</span> taskset <span class="at">-p</span> 0x11 9726</span></code></pre></div>
<p>Podobne ustawienie istnieje również w menedżerze zadań systemu Windows</p>
<p><img src="assets/affinity.png" /></p>
</section>
</section>
<section id="procesy" class="level1">
<h1>Procesy</h1>
<section id="procesy-w-systemie-linux" class="level2">
<h2>Procesy w systemie Linux</h2>
<p>Procesem nazywamy program, który się wykonuje. W skład procesu wchodzą:</p>
<ul class="incremental">
<li><strong>Stan procesora (rejestry).</strong> Dla <code>x86_64</code> są to:
<ul class="incremental">
<li><code>rbp</code> - wskaźnik początku stosu</li>
<li><code>rsp</code> - wskaźnik końca stosu (ang. Stack pointer)</li>
<li><code>rip</code> - wskaźnik aktualnej instrukcji (ang. Program counter)</li>
<li><code>rflags</code> - rejest flag procesora</li>
<li>rejestry ogólnego przeznaczenia: <code>rax</code>, <code>rcx</code>, <code>rdx</code>, <code>rbx</code>, <code>rsi</code>, <code>rdi</code>, <code>r8</code>-<code>r15</code></li>
</ul></li>
<li><strong>Pamięć wirtualna</strong> (Tabela stron) (wskazywana przez rejestr <code>CR3</code>)</li>
<li><strong>Deskryptory plików</strong>, czyli (najważniejsze):
<ul class="incremental">
<li>pliki (otwarte za pomocą <code>open()</code>)</li>
<li>gniazda sieciowe (otwarte za pomocą <code>socket()</code>, <code>accept()</code>)</li>
<li>potoki (otwarte za pomocą <code>pipe()</code>)</li>
<li>demultiplexery zdarzeń (otwarte za pomocą <code>epoll_create()</code>)</li>
</ul></li>
<li>Inne struktury danych istotne dla jądra Linux</li>
</ul>
</section>
<section id="podglądanie-procesów-w-systemie" class="level2">
<h2>Podglądanie procesów w systemie</h2>
<p>W systemie Linux, uruchomione procesy możemy zobaczyć za pomocą programu <code>ps</code></p>
<pre class="console"><code>$ ps
  PID TTY           TIME CMD
  896 ttys000    0:00.10 -bash
 1073 ttys001    0:00.08 -bash
 7601 ttys001    0:00.02 bash /Users/hehe/v/e @
 7603 ttys001    1:40.37 nvim
 1074 ttys002    0:00.15 -bash
75444 ttys002    0:00.00 (sleep)
 6110 ttys003    0:00.50 -bash
75450 ttys003    0:00.00 bash /Users/hehe/v/y
 7870 ttys004    0:00.09 -bash
75448 ttys004    0:00.00 sleep 1</code></pre>
<p>Liczba <code>PID</code> to unikalny identyfikator procesu.</p>
</section>
<section id="podglądanie-procesów-w-systemie---top" class="level2">
<h2>Podglądanie procesów w systemie - top</h2>
<p>Programy <code>top</code> oraz <code>htop</code> umożliwają podgląd procesów w czasie rzeczywistym</p>
<pre class="console"><code>$ top
top - 22:20:33 up 56 min,  1 user,  load average: 0,33, 0,52, 0,56
Zadania:razem: 328, działających:   2, śpiących: 326, zatrzymanych:   0, zombie:   0
%CPU:  2,9 uż,  1,8 sy,  0,0 ni, 95,3 be,  0,0 io,  0,0 hi,  0,0 si,  0,0 sk
MiB RAM :  15888,6 razem,   9129,5 wolne,   3037,6 użyte,   3721,6 buf/cache
MiB Swap:   4880,0 razem,   4880,0 wolne,      0,0 użyte.  12497,1 dost. RAM

    PID UŻYTK.    PR  NI    WIRT    REZ    WSP S  %CPU  %PAM     CZAS+ KOMENDA
   1452 hehe       9 -11 2731536  20752  16068 S   8,0   0,1   0:55.86 pulseaudio
   3269 hehe      20   0  522940  55472  40716 R   5,7   0,3   4:34.44 x-terminal-emul
   9773 hehe      20   0  217860  52624  35892 S   4,6   0,3   1:22.04 MainThread
   5321 hehe      20   0 4935640 751040 310720 S   3,4   4,6   4:44.81 firefox
   8058 hehe      20   0  319064  50504  39920 S   2,3   0,3   0:54.45 RDD Process
  34580 hehe      20   0   23400   4224   3288 R   2,3   0,0   0:00.05 top
    287 root      20   0       0      0      0 I   1,1   0,0   0:02.22 kworker/4:1-events
   1903 hehe      20   0 4463536 392068 118248 S   1,1   2,4   1:30.14 gnome-shell
   1989 hehe      20   0  396140   8576   7056 S   1,1   0,1   0:20.24 ibus-daemon
   2286 hehe      20   0 5165376 252416  77816 S   1,1   1,6   0:09.15 dropbox
      1 root      20   0  170040  14056   8280 S   0,0   0,1   0:01.51 systemd</code></pre>
</section>
<section id="podglądanie-procesów-w-systemie---pseudo-system-plików-proc" class="level2">
<h2>Podglądanie procesów w systemie - pseudo system plików /proc</h2>
<pre class="console"><code>$ ls /proc
1   42   129  289  978   1259  1580  2103  8238   34694          kpageflags
2   43   132  290  981   1285  1627  2104  8403   34695          loadavg
3   44   133  291  986   1286  1630  2105  8648   35412          locks
4   46   136  349  990   1301  1762  2106  8808   35848          mdstat
6   47   138  350  994   1358  1780  2107  8827   35849          meminfo
8   48   139  351  1009  1374  1850  2109  8968   35855          misc
9   49   142  353  1011  1377  1870  2110  8970   acpi           modules
10  50   150  437  1013  1378  1875  2118  9421   asound         mounts
11  52   153  438  1015  1379  1881  2192  9773   bootconfig     mtrr
12  53   154  491  1017  1380  1888  2194  10510  buddyinfo      net
13  54   159  519  1019  1381  1903  2247  12703  bus            pagetypeinfo
14  55   194  520  1021  1407  1989  2260  13057  cgroups        partitions
15  56   219  522  1023  1411  1993  2286  13159  cmdline        pressure
16  58   221  524  1025  1412  1994  2376  15059  consoles       schedstat
17  59   242  526  1078  1414  1998  2391  19363  cpuinfo        scsi
18  60   244  528  1079  1421  2004  2513  19374  crypto         self
19  61   245  529  1116  1450  2008  2681  27384  devices        slabinfo
20  62   247  620  1117  1452  2016  3269  27437  diskstats      softirqs</code></pre>
</section>
<section id="drzewo-procesów" class="level2">
<h2>Drzewo procesów</h2>
<p>Drzewo procesów możemy ujrzeć za pomocą programu <code>pstree</code></p>
<pre class="console"><code>$ pstree
systemd─┬─ModemManager───2*[{ModemManager}]
        ├─NetworkManager───2*[{NetworkManager}]
        ├─fwupd───4*[{fwupd}]
        ├─gdm3─┬─gdm-session-wor─┬─gdm-x-session─┬─Xorg───{Xorg}
        │      │                 │               ├─gnome-session-b─┬─ssh-agent
        │      │                 │               │                 └─2*[{gnome-session-b}]
        │      │                 │               └─2*[{gdm-x-session}]
        │      │                 └─2*[{gdm-session-wor}]
        │      └─2*[{gdm3}]
        ├─polkitd───2*[{polkitd}]
        ├─systemd─┬─(sd-pam)
        │         ├─tmux: server─┬─bash───bash───nvim─┬─2*[xclip]
        │         │              │                    └─{nvim}
        │         │              ├─bash───bash───sleep
        │         │              ├─bash
        │         │              └─bash─┬─bash
        │         │                     └─pstree
       ...       ...</code></pre>
</section>
</section>
<section id="wywołania-systemowe" class="level1">
<h1>Wywołania systemowe</h1>
<section id="wywołania-systemowe-1" class="level2">
<h2>Wywołania systemowe</h2>
<p>Procesy prowadzą interakcję z systemem operacyjnym za pomocą wywołań systemowych.</p>
<p>Wywołanie systemowe to przerwanie wywołane przez proces, w celu zarządania od systemu operacyjnego wykonania określonej czynności.</p>
<p>Tą czynnością może być, na przykład:</p>
<ul class="incremental">
<li>otwarcie pliku - <code>open()</code></li>
<li>odczyt danych z deskryptora pliku - <code>read()</code></li>
<li>sklonowanie obecnego procesu - <code>fork()</code></li>
<li>utworzenie gniazda sieciowego - <code>socket()</code></li>
</ul>
<p>Wywołania systemowe są potrzebne, żeby zapewnić odpowiednią warstwę abstrakcji pomiędzy procesem a zasobami zarządzanymi przez system operacyjny.</p>
</section>
<section id="co-jest-efektem-kompilacji" class="level2">
<h2>Co jest efektem kompilacji?</h2>
<p>Kod w języku C jest kompilowany do instrukcji maszynowych</p>
<div class="sourceCode" id="cb6"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a><span class="dt">int</span> foo<span class="op">(</span><span class="dt">int</span> a<span class="op">,</span> <span class="dt">int</span> b<span class="op">)</span></span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a><span class="op">{</span></span>
<span id="cb6-3"><a href="#cb6-3" aria-hidden="true" tabindex="-1"></a>    <span class="dt">int</span> c <span class="op">=</span> a <span class="op">+</span> b<span class="op">;</span></span>
<span id="cb6-4"><a href="#cb6-4" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> c<span class="op">;</span></span>
<span id="cb6-5"><a href="#cb6-5" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<pre class="console"><code>$ gcc main.c -S -O0 -o -
_foo: 
pushq %rbp            ; Zapisz podstawe stosu
movq  %rsp, %rbp      ; Weź szczyt stosu jako podstawę
movl  %edi, %eax      ; Przenieś pierwszy argument do %eax
addl  %esi, %eax      ; Dodaj drugi argument do %eax
movl  %eax, -4(%rbp)  ; Wynik umieść na stosie
movl  -4(%rbp), %eax  ; Przekaż wartość zwracaną przez %eax
popq  %rbp            ; Załaduj zapisaną podstawę stosu
retq                  ; Wróć z powrotem w miejsce wywołania  </code></pre>
<p>Godbolt: <a href="https://godbolt.org/z/cd947Ko75">https://godbolt.org/z/cd947Ko75</a></p>
</section>
<section id="instrukcje-uprzywilejowane" class="level2">
<h2>Instrukcje uprzywilejowane</h2>
<p>Nie wszystkie instrukcje procesora są dostępne dla procesów użytkownika. Procesy użytkownika nie mogą między innymi odczytywać pamięci chronionej, ani wykonywać niektórych instrukcji. Na przykład:</p>
<ul class="incremental">
<li><code>LGDT</code> - nadpisywanie tablicy przerwań;</li>
<li><code>IN</code>, <code>OUT</code> - obługa urządzeń wejścia/wyjścia;</li>
<li><code>MOV %eax, %cr3</code> - modyfikacja tablicy stron.</li>
</ul>
<p>Procesy mogą jedynie “prosić” system operacyjny, żeby on w ich imieniu wykonywał te instrukcje. Tą prośbą są <strong>wywołania systemowe</strong>.</p>
</section>
<section id="wywołania-systemowe-2" class="level2">
<h2>Wywołania systemowe</h2>
<p>Wywołania systemowe, są przerwaniem programowym (ang. software interrupt)</p>
<ol class="incremental" type="1">
<li>Program wykonuje przerwanie (<code>syscall</code> lub <code>int 0x80</code>), w rejestrach ustawia odpowieni numer przerwania oraz przekazuje odpowiednie argumenty</li>
<li>System operacyjny zaczyna wykonywać procedurę obsługi tego przerwania: zapisuje stan procesora, przełącza stos programu na stos jądra (zmienia rejestr <code>%esp</code> - wskaźnik stosu), i wykonuje odpowiednią operację wskazaną numerem wywołania systemowego.</li>
<li>Po wykonaniu wywołania systemowego system operacyjny przywraca stan procesora (w tym stos procesu) i wznawiane jest wykonywanie programu.</li>
</ol>
<div class="sourceCode" id="cb8"><pre class="sourceCode asm"><code class="sourceCode fasm"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a><span class="fu">message:</span></span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true" tabindex="-1"></a>    .asciz <span class="st">&quot;Hello world\n&quot;</span></span>
<span id="cb8-3"><a href="#cb8-3" aria-hidden="true" tabindex="-1"></a>.<span class="bu">set</span> message_size<span class="op">,</span> <span class="op">.</span> <span class="op">-</span> message</span>
<span id="cb8-4"><a href="#cb8-4" aria-hidden="true" tabindex="-1"></a>...</span>
<span id="cb8-5"><a href="#cb8-5" aria-hidden="true" tabindex="-1"></a>movl <span class="op">$</span><span class="bn">1</span><span class="op">,</span> <span class="op">%</span><span class="kw">edi</span></span>
<span id="cb8-6"><a href="#cb8-6" aria-hidden="true" tabindex="-1"></a>leaq message<span class="op">(%</span>rip<span class="op">),</span> <span class="op">%</span><span class="kw">rsi</span></span>
<span id="cb8-7"><a href="#cb8-7" aria-hidden="true" tabindex="-1"></a><span class="bu">movq</span> <span class="op">$</span>message_size<span class="op">,</span> <span class="op">%</span><span class="kw">rdx</span></span>
<span id="cb8-8"><a href="#cb8-8" aria-hidden="true" tabindex="-1"></a><span class="bu">movq</span> <span class="op">$</span><span class="bn">1</span><span class="op">,</span> <span class="op">%</span><span class="kw">rax</span>             <span class="co">;1 is sys_write syscall number</span></span>
<span id="cb8-9"><a href="#cb8-9" aria-hidden="true" tabindex="-1"></a><span class="cf">syscall</span></span></code></pre></div>
</section>
<section id="wywołania-systemowe-a-funkcje" class="level2">
<h2>Wywołania systemowe a funkcje</h2>
<p>Biblioteka standardowa języka C (np. <code>glibc</code>, <code>musl</code> lub <code>uClibc</code>), implementuje funkcje, które uruchamiają wywołania systemowe o podobnych nazwach. Oprócz tego implementuje jeszcze dodatkową funkcjonalność oraz funkcje, które nie są wywołaniami systemowymi.</p>
<p>Przykłady:</p>
<table>
<thead>
<tr class="header">
<th>funkcja</th>
<th>typ</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td><code>open()</code></td>
<td><code>syscall(SYS_open, ...)</code></td>
</tr>
<tr class="even">
<td><code>fork()</code></td>
<td><code>syscall(SYS_fork, ...)</code></td>
</tr>
<tr class="odd">
<td><code>write()</code></td>
<td><code>syscall(SYS_write, ...)</code></td>
</tr>
<tr class="even">
<td><code>read()</code></td>
<td><code>syscall(SYS_read, ...)</code></td>
</tr>
<tr class="odd">
<td><code>printf()</code></td>
<td><code>syscall(SYS_write)</code> + dodatkowa funkcjonalność</td>
</tr>
<tr class="even">
<td><code>malloc()</code></td>
<td><code>syscall(SYS_brk)</code> + dodatkowa funkcjonalność</td>
</tr>
<tr class="odd">
<td><code>fopen()</code></td>
<td><code>syscall(SYS_open)</code> + dodatkowa funkcjonalność</td>
</tr>
<tr class="even">
<td><code>strlen()</code></td>
<td>funkcja biblioteczna</td>
</tr>
<tr class="odd">
<td><code>memcpy()</code></td>
<td>funkcja biblioteczna</td>
</tr>
</tbody>
</table>
</section>
</section>
<section id="tworzenie-procesów" class="level1">
<h1>Tworzenie procesów</h1>
<section id="pid-procesu" class="level2">
<h2>PID procesu</h2>
<p>Procesy posiadają unikalny identyfikator - PID (ang. Process Identifier). Do przechowywania identyfikatora procesu służy typ danych <code>pid_t</code>. Typ <code>pid_t</code> najczęsciej definiowany jest jako <code>int</code>, ale POSIX wymaga tylko, żeby była to liczba całkowita ze znakiem.</p>
<p>Wywołania <code>getpid()</code> i <code>getppid()</code> zwracają odpowiednio PID procesu oraz PID jego rodzica.</p>
<div class="sourceCode" id="cb9"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;unistd.h&gt;</span></span>
<span id="cb9-2"><a href="#cb9-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-3"><a href="#cb9-3" aria-hidden="true" tabindex="-1"></a>pid_t getpid<span class="op">(</span><span class="dt">void</span><span class="op">);</span></span>
<span id="cb9-4"><a href="#cb9-4" aria-hidden="true" tabindex="-1"></a>pid_t getppid<span class="op">(</span><span class="dt">void</span><span class="op">);</span></span></code></pre></div>
<div class="sourceCode" id="cb10"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;unistd.h&gt;</span></span>
<span id="cb10-2"><a href="#cb10-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-3"><a href="#cb10-3" aria-hidden="true" tabindex="-1"></a><span class="dt">int</span> main<span class="op">(</span><span class="dt">void</span><span class="op">)</span></span>
<span id="cb10-4"><a href="#cb10-4" aria-hidden="true" tabindex="-1"></a><span class="op">{</span></span>
<span id="cb10-5"><a href="#cb10-5" aria-hidden="true" tabindex="-1"></a>    pid_t pid <span class="op">=</span> getpid<span class="op">();</span></span>
<span id="cb10-6"><a href="#cb10-6" aria-hidden="true" tabindex="-1"></a>    pid_t parent <span class="op">=</span> getppid<span class="op">();</span></span>
<span id="cb10-7"><a href="#cb10-7" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> <span class="dv">0</span><span class="op">;</span></span>
<span id="cb10-8"><a href="#cb10-8" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
</section>
<section id="wywołanie-systemowe---fork" class="level2">
<h2>Wywołanie systemowe - <code>fork()</code></h2>
<p>Do tworzenia procesów, służy wywołanie systemowe <code>fork()</code>.</p>
<div class="sourceCode" id="cb11"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;unistd.h&gt;</span></span>
<span id="cb11-2"><a href="#cb11-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-3"><a href="#cb11-3" aria-hidden="true" tabindex="-1"></a>pid_t fork<span class="op">(</span><span class="dt">void</span><span class="op">);</span></span></code></pre></div>
<p>Utworzony proces potomny:</p>
<ul class="incremental">
<li>Jest klonem procesu rodzica</li>
<li>Otrzymuje unikalny PID.</li>
<li>Ma inny PID rodzica. To PID który wywołał <code>fork()</code>.</li>
<li>Używa dalej tego samego kodu programu.</li>
<li>Otrzymuje skopiowany jest stan procesora (w tym wskaźnik aktualnej instrukcji).</li>
<li>Otrzymuje kopię tablicy deskryptorów plików.</li>
<li>Otrzymuje kopię stron pamięci, ale dopiero po pierwszym zapisie (Copy-on-write).</li>
</ul>
</section>
<section id="przykład-działania-fork" class="level2">
<h2>Przykład działania <code>fork()</code></h2>
<p>Poniższy kod przedstawia koncepcję działania <code>fork()</code>.</p>
<div class="sourceCode" id="cb12"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a>   <span class="dt">int</span> main<span class="op">(</span><span class="dt">void</span><span class="op">)</span></span>
<span id="cb12-2"><a href="#cb12-2" aria-hidden="true" tabindex="-1"></a>   <span class="op">{</span></span>
<span id="cb12-3"><a href="#cb12-3" aria-hidden="true" tabindex="-1"></a>       printf<span class="op">(</span><span class="st">&quot;przed utworzeniem</span><span class="sc">\n</span><span class="st">&quot;</span><span class="op">);</span></span>
<span id="cb12-4"><a href="#cb12-4" aria-hidden="true" tabindex="-1"></a><span class="op">--&gt;</span>    pid_t pid <span class="op">=</span> fork<span class="op">();</span></span>
<span id="cb12-5"><a href="#cb12-5" aria-hidden="true" tabindex="-1"></a>       <span class="op">...</span></span>
<span id="cb12-6"><a href="#cb12-6" aria-hidden="true" tabindex="-1"></a>   <span class="op">}</span></span></code></pre></div>
<p>Po wywołaniu <code>fork()</code>:</p>
<div class="sourceCode" id="cb13"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a>   <span class="co">/* rodzic */</span>                         <span class="co">/* dziecko */</span></span>
<span id="cb13-2"><a href="#cb13-2" aria-hidden="true" tabindex="-1"></a>   <span class="dt">int</span> main<span class="op">(</span><span class="dt">void</span><span class="op">)</span>                       <span class="dt">int</span> main<span class="op">(</span><span class="dt">void</span><span class="op">)</span></span>
<span id="cb13-3"><a href="#cb13-3" aria-hidden="true" tabindex="-1"></a>   <span class="op">{</span>                                    <span class="op">{</span></span>
<span id="cb13-4"><a href="#cb13-4" aria-hidden="true" tabindex="-1"></a>       printf<span class="op">(</span><span class="st">&quot;przed utworzeniem</span><span class="sc">\n</span><span class="st">&quot;</span><span class="op">);</span>       printf<span class="op">(</span><span class="st">&quot;przed utworzeniem</span><span class="sc">\n</span><span class="st">&quot;</span><span class="op">);</span></span>
<span id="cb13-5"><a href="#cb13-5" aria-hidden="true" tabindex="-1"></a><span class="op">--&gt;</span>    pid_t pid <span class="op">=</span> fork<span class="op">();</span>           <span class="op">--&gt;</span>    pid_t pid <span class="op">=</span> fork<span class="op">();</span> <span class="co">// (0)</span></span>
<span id="cb13-6"><a href="#cb13-6" aria-hidden="true" tabindex="-1"></a>       <span class="op">...</span>                                  <span class="op">...</span></span>
<span id="cb13-7"><a href="#cb13-7" aria-hidden="true" tabindex="-1"></a>   <span class="op">}</span>                                    <span class="op">}</span></span></code></pre></div>
</section>
<section id="wartość-zwracana-fork" class="level2">
<h2>Wartość zwracana <code>fork()</code></h2>
<p>Wywołanie <code>fork()</code> w procesie potomnym zwraca <code>0</code>, natomiast w procesie rodzica wartością zwróconą będzie PID procesu potomnego.</p>
<div class="sourceCode" id="cb14"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a>   <span class="co">/* rodzic */</span>                         <span class="co">/* dziecko */</span></span>
<span id="cb14-2"><a href="#cb14-2" aria-hidden="true" tabindex="-1"></a>    <span class="dt">int</span> main<span class="op">(</span><span class="dt">void</span><span class="op">)</span>                       <span class="dt">int</span> main<span class="op">(</span><span class="dt">void</span><span class="op">)</span></span>
<span id="cb14-3"><a href="#cb14-3" aria-hidden="true" tabindex="-1"></a>    <span class="op">{</span>                                    <span class="op">{</span></span>
<span id="cb14-4"><a href="#cb14-4" aria-hidden="true" tabindex="-1"></a>        printf<span class="op">(</span><span class="st">&quot;przed utworzeniem</span><span class="sc">\n</span><span class="st">&quot;</span><span class="op">);</span>       printf<span class="op">(</span><span class="st">&quot;przed utworzeniem</span><span class="sc">\n</span><span class="st">&quot;</span><span class="op">)</span>j</span>
<span id="cb14-5"><a href="#cb14-5" aria-hidden="true" tabindex="-1"></a>        pid_t pid <span class="op">=</span> fork<span class="op">();</span>                  pid_t pid <span class="op">=</span> fork<span class="op">();</span></span>
<span id="cb14-6"><a href="#cb14-6" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="op">(</span>pid <span class="op">==</span> <span class="dv">0</span><span class="op">)</span>                        <span class="cf">if</span> <span class="op">(</span>pid <span class="op">==</span> <span class="dv">0</span><span class="op">)</span></span>
<span id="cb14-7"><a href="#cb14-7" aria-hidden="true" tabindex="-1"></a>            printf<span class="op">(</span><span class="st">&quot;child</span><span class="sc">\n</span><span class="st">&quot;</span><span class="op">);</span>        <span class="op">--&gt;</span>        printf<span class="op">(</span><span class="st">&quot;child</span><span class="sc">\n</span><span class="st">&quot;</span><span class="op">);</span>   </span>
<span id="cb14-8"><a href="#cb14-8" aria-hidden="true" tabindex="-1"></a>        <span class="cf">else</span>                                 <span class="cf">else</span></span>
<span id="cb14-9"><a href="#cb14-9" aria-hidden="true" tabindex="-1"></a> <span class="op">--&gt;</span>        printf<span class="op">(</span><span class="st">&quot;parent</span><span class="sc">\n</span><span class="st">&quot;</span><span class="op">);</span>                  printf<span class="op">(</span><span class="st">&quot;parent</span><span class="sc">\n</span><span class="st">&quot;</span><span class="op">);</span>  </span>
<span id="cb14-10"><a href="#cb14-10" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="dv">0</span><span class="op">;</span>                            <span class="cf">return</span> <span class="dv">0</span><span class="op">;</span></span>
<span id="cb14-11"><a href="#cb14-11" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span>                                    <span class="op">}</span></span></code></pre></div>
<p>Na podstawie wartości zwracanej, możemy określić czy “znajdujemy” się w procesie potomnym czy w procesie rodzica.</p>
</section>
<section id="oczekiwanie-na-zakończenie-procesu-potomnego" class="level2">
<h2>Oczekiwanie na zakończenie procesu potomnego</h2>
<p>Do oczekiwania na zakończenie procesu potomnego służy, wywołanie systemowe <code>wait()</code>, które blokuje program do momentu zakończenia dowolnego procesu potomnego.</p>
<div class="sourceCode" id="cb15"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true" tabindex="-1"></a>   <span class="co">/* rodzic */</span>                         <span class="co">/* dziecko */</span></span>
<span id="cb15-2"><a href="#cb15-2" aria-hidden="true" tabindex="-1"></a>    <span class="dt">int</span> main<span class="op">(</span><span class="dt">void</span><span class="op">)</span>                       <span class="dt">int</span> main<span class="op">(</span><span class="dt">void</span><span class="op">)</span></span>
<span id="cb15-3"><a href="#cb15-3" aria-hidden="true" tabindex="-1"></a>    <span class="op">{</span>                                    <span class="op">{</span></span>
<span id="cb15-4"><a href="#cb15-4" aria-hidden="true" tabindex="-1"></a>        printf<span class="op">(</span><span class="st">&quot;przed utworzeniem</span><span class="sc">\n</span><span class="st">&quot;</span><span class="op">);</span>       printf<span class="op">(</span><span class="st">&quot;przed utworzeniem</span><span class="sc">\n</span><span class="st">&quot;</span><span class="op">)</span>j</span>
<span id="cb15-5"><a href="#cb15-5" aria-hidden="true" tabindex="-1"></a>        pid_t pid <span class="op">=</span> fork<span class="op">();</span>                  pid_t pid <span class="op">=</span> fork<span class="op">();</span></span>
<span id="cb15-6"><a href="#cb15-6" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="op">(</span>pid <span class="op">==</span> <span class="dv">0</span><span class="op">)</span> <span class="op">{</span>                      <span class="cf">if</span> <span class="op">(</span>pid <span class="op">==</span> <span class="dv">0</span><span class="op">)</span> <span class="op">{</span></span>
<span id="cb15-7"><a href="#cb15-7" aria-hidden="true" tabindex="-1"></a>            printf<span class="op">(</span><span class="st">&quot;child</span><span class="sc">\n</span><span class="st">&quot;</span><span class="op">);</span>                   printf<span class="op">(</span><span class="st">&quot;child</span><span class="sc">\n</span><span class="st">&quot;</span><span class="op">);</span>   </span>
<span id="cb15-8"><a href="#cb15-8" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span> <span class="cf">else</span> <span class="op">{</span>                             <span class="op">}</span> <span class="cf">else</span> <span class="op">{</span></span>
<span id="cb15-9"><a href="#cb15-9" aria-hidden="true" tabindex="-1"></a>            printf<span class="op">(</span><span class="st">&quot;parent</span><span class="sc">\n</span><span class="st">&quot;</span><span class="op">);</span>                  printf<span class="op">(</span><span class="st">&quot;parent</span><span class="sc">\n</span><span class="st">&quot;</span><span class="op">);</span>  </span>
<span id="cb15-10"><a href="#cb15-10" aria-hidden="true" tabindex="-1"></a> <span class="op">--&gt;</span>        wait<span class="op">(</span>NULL<span class="op">);</span>                          wait<span class="op">(</span>NULL<span class="op">);</span></span>
<span id="cb15-11"><a href="#cb15-11" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span>                                    <span class="op">}</span></span>
<span id="cb15-12"><a href="#cb15-12" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="dv">0</span><span class="op">;</span>                     <span class="op">--&gt;</span>    <span class="cf">return</span> <span class="dv">0</span><span class="op">;</span></span>
<span id="cb15-13"><a href="#cb15-13" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span>                                    <span class="op">}</span></span></code></pre></div>
</section>
<section id="wizualizacja" class="level2">
<h2>Wizualizacja</h2>
<p><img src="assets/processes.svg" /></p>
</section>
<section id="wait-obsługa-błędów" class="level2">
<h2><code>wait()</code> obsługa błędów</h2>
<p>Wywołanie systemowe <code>wait()</code> zwraca <code>pid</code> zakończonego procesu. Jeżeli wartość jest ujemna to wystąpił błąd. Błąd uzyskać można odczytująć zmienną <code>errno</code>.</p>
<div class="sourceCode" id="cb16"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb16-1"><a href="#cb16-1" aria-hidden="true" tabindex="-1"></a>pid_t pid <span class="op">=</span> wait<span class="op">(</span>NULL<span class="op">);</span></span>
<span id="cb16-2"><a href="#cb16-2" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> <span class="op">(</span>pid <span class="op">&lt;</span> <span class="dv">0</span><span class="op">)</span> <span class="op">{</span></span>
<span id="cb16-3"><a href="#cb16-3" aria-hidden="true" tabindex="-1"></a>    fprintf<span class="op">(</span>stderr<span class="op">,</span> <span class="st">&quot;error: wait: </span><span class="sc">%s\n</span><span class="st">&quot;</span><span class="op">,</span> strerror<span class="op">(</span>errno<span class="op">));</span></span>
<span id="cb16-4"><a href="#cb16-4" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> <span class="op">-</span><span class="dv">1</span><span class="op">;</span></span>
<span id="cb16-5"><a href="#cb16-5" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
</section>
<section id="wait-odczytanie-wartości-zwracanej" class="level2">
<h2><code>wait()</code> odczytanie wartości zwracanej</h2>
<p>Można odczytać wartość jaką zwrócił proces potomny przekazując wskaźnik jako pierwszy argument wywołania <code>wait()</code>.</p>
<div class="sourceCode" id="cb17"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb17-1"><a href="#cb17-1" aria-hidden="true" tabindex="-1"></a><span class="dt">int</span> status<span class="op">;</span></span>
<span id="cb17-2"><a href="#cb17-2" aria-hidden="true" tabindex="-1"></a>pid_t pid <span class="op">=</span> wait<span class="op">(&amp;</span>status<span class="op">);</span></span>
<span id="cb17-3"><a href="#cb17-3" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> <span class="op">(</span>pid <span class="op">&lt;</span> <span class="dv">0</span><span class="op">)</span> <span class="op">{</span></span>
<span id="cb17-4"><a href="#cb17-4" aria-hidden="true" tabindex="-1"></a>    fprintf<span class="op">(</span>stderr<span class="op">,</span> <span class="st">&quot;error: wait: </span><span class="sc">%s\n</span><span class="st">&quot;</span><span class="op">,</span> strerror<span class="op">(</span>errno<span class="op">));</span></span>
<span id="cb17-5"><a href="#cb17-5" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> <span class="op">-</span><span class="dv">1</span><span class="op">;</span></span>
<span id="cb17-6"><a href="#cb17-6" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb17-7"><a href="#cb17-7" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> <span class="op">(</span>WIFEXITED<span class="op">(</span>status<span class="op">))</span></span>
<span id="cb17-8"><a href="#cb17-8" aria-hidden="true" tabindex="-1"></a>    printf<span class="op">(</span><span class="st">&quot;dziecko zwróciło: </span><span class="sc">%d\n</span><span class="st">&quot;</span><span class="op">,</span> WEXITSTATUS<span class="op">(</span>status<span class="op">));</span></span></code></pre></div>
</section>
<section id="oczekiwanie-na-zakończenie-kilku-procesów-potomnych" class="level2">
<h2>Oczekiwanie na zakończenie kilku procesów potomnych</h2>
<p>Wywołanie systemowe <code>wait()</code> czeka na pierwszy proces potomny, który ulegnie zakończeniu. Jeżeli utworzonych zostało więcej procesów potomnych, to należy ponowić oczekiwanie.</p>
<div class="sourceCode" id="cb18"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb18-1"><a href="#cb18-1" aria-hidden="true" tabindex="-1"></a><span class="cf">while</span> <span class="op">(</span>true<span class="op">)</span> <span class="op">{</span></span>
<span id="cb18-2"><a href="#cb18-2" aria-hidden="true" tabindex="-1"></a>    pid_t pid <span class="op">=</span> wait<span class="op">(</span>NULL<span class="op">);</span></span>
<span id="cb18-3"><a href="#cb18-3" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="op">(</span>pid <span class="op">&lt;</span> <span class="dv">0</span><span class="op">)</span> <span class="op">{</span></span>
<span id="cb18-4"><a href="#cb18-4" aria-hidden="true" tabindex="-1"></a>        <span class="co">/* Nie ma już dzieci */</span></span>
<span id="cb18-5"><a href="#cb18-5" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="op">(</span>errno <span class="op">==</span> ECHILD<span class="op">)</span></span>
<span id="cb18-6"><a href="#cb18-6" aria-hidden="true" tabindex="-1"></a>            <span class="cf">break</span><span class="op">;</span></span>
<span id="cb18-7"><a href="#cb18-7" aria-hidden="true" tabindex="-1"></a>        <span class="co">/* Wystąpił rzeczywisty błąd */</span></span>
<span id="cb18-8"><a href="#cb18-8" aria-hidden="true" tabindex="-1"></a>        fprintf<span class="op">(</span>stderr<span class="op">,</span> <span class="st">&quot;error: wait: </span><span class="sc">%s\n</span><span class="st">&quot;</span><span class="op">,</span> strerror<span class="op">(</span>errno<span class="op">));</span></span>
<span id="cb18-9"><a href="#cb18-9" aria-hidden="true" tabindex="-1"></a>        <span class="cf">break</span><span class="op">;</span></span>
<span id="cb18-10"><a href="#cb18-10" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb18-11"><a href="#cb18-11" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
</section>
<section id="wywołanie-waitpid" class="level2">
<h2>Wywołanie <code>waitpid()</code></h2>
<p>Wywołanie systemowe <code>waitpid()</code> pozwala zaczekać na konkretny process potomny.</p>
<div class="sourceCode" id="cb19"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb19-1"><a href="#cb19-1" aria-hidden="true" tabindex="-1"></a><span class="dt">int</span> status<span class="op">;</span></span>
<span id="cb19-2"><a href="#cb19-2" aria-hidden="true" tabindex="-1"></a>pid_t pid <span class="op">=</span> waitpid<span class="op">(</span>pid<span class="op">,</span> <span class="op">&amp;</span>status<span class="op">,</span> <span class="dv">0</span><span class="op">);</span></span>
<span id="cb19-3"><a href="#cb19-3" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> <span class="op">(</span>pid <span class="op">&lt;</span> <span class="dv">0</span><span class="op">)</span> <span class="op">{</span></span>
<span id="cb19-4"><a href="#cb19-4" aria-hidden="true" tabindex="-1"></a>    fprintf<span class="op">(</span>stderr<span class="op">,</span> <span class="st">&quot;error: waitpid: </span><span class="sc">%s\n</span><span class="st">&quot;</span><span class="op">,</span> strerror<span class="op">(</span>errno<span class="op">));</span></span>
<span id="cb19-5"><a href="#cb19-5" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> <span class="op">-</span><span class="dv">1</span><span class="op">;</span></span>
<span id="cb19-6"><a href="#cb19-6" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb19-7"><a href="#cb19-7" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> <span class="op">(</span>WIFEXITED<span class="op">(</span>status<span class="op">))</span></span>
<span id="cb19-8"><a href="#cb19-8" aria-hidden="true" tabindex="-1"></a>    printf<span class="op">(</span><span class="st">&quot;dziecko zwróciło: </span><span class="sc">%d\n</span><span class="st">&quot;</span><span class="op">,</span> WEXITSTATUS<span class="op">(</span>status<span class="op">));</span></span></code></pre></div>
<p>Tak naprawde <code>wait()</code> działa tak samo jak:</p>
<div class="sourceCode" id="cb20"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb20-1"><a href="#cb20-1" aria-hidden="true" tabindex="-1"></a>pid_t pid <span class="op">=</span> waitpid<span class="op">(-</span><span class="dv">1</span><span class="op">,</span> <span class="op">&amp;</span>status<span class="op">,</span> <span class="dv">0</span><span class="op">);</span></span></code></pre></div>
</section>
<section id="wywołanie-waitpid-w-trybie-nieblokującym" class="level2">
<h2>Wywołanie <code>waitpid()</code> w trybie nieblokującym</h2>
<p>Opcja <code>WNOHANG</code> umożliwia oczekiwanie na zakończenie procesu potomnego, nie blokując przy tym procesu rodzica.</p>
<div class="sourceCode" id="cb21"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb21-1"><a href="#cb21-1" aria-hidden="true" tabindex="-1"></a>pid_t pid <span class="op">=</span> fork<span class="op">();</span></span>
<span id="cb21-2"><a href="#cb21-2" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> <span class="op">(</span>pid <span class="op">==</span> <span class="dv">0</span><span class="op">)</span> <span class="op">{</span></span>
<span id="cb21-3"><a href="#cb21-3" aria-hidden="true" tabindex="-1"></a>    sleep<span class="op">(</span><span class="dv">3</span><span class="op">);</span></span>
<span id="cb21-4"><a href="#cb21-4" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> <span class="dv">0</span><span class="op">;</span></span>
<span id="cb21-5"><a href="#cb21-5" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb21-6"><a href="#cb21-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-7"><a href="#cb21-7" aria-hidden="true" tabindex="-1"></a><span class="cf">while</span> <span class="op">(</span><span class="dv">1</span><span class="op">)</span> <span class="op">{</span></span>
<span id="cb21-8"><a href="#cb21-8" aria-hidden="true" tabindex="-1"></a>    pid_t pid <span class="op">=</span> waitpid<span class="op">(-</span><span class="dv">1</span><span class="op">,</span> NULL<span class="op">,</span> WNOHANG<span class="op">);</span></span>
<span id="cb21-9"><a href="#cb21-9" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="op">(</span>pid <span class="op">==</span> <span class="dv">0</span><span class="op">)</span> <span class="op">{</span></span>
<span id="cb21-10"><a href="#cb21-10" aria-hidden="true" tabindex="-1"></a>        printf<span class="op">(</span><span class="st">&quot;child is still running...</span><span class="sc">\n</span><span class="st">&quot;</span><span class="op">);</span></span>
<span id="cb21-11"><a href="#cb21-11" aria-hidden="true" tabindex="-1"></a>        sleep<span class="op">(</span><span class="dv">1</span><span class="op">);</span></span>
<span id="cb21-12"><a href="#cb21-12" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span> <span class="cf">else</span> <span class="cf">if</span> <span class="op">(</span>pid <span class="op">&lt;</span> <span class="dv">0</span><span class="op">)</span> <span class="op">{</span></span>
<span id="cb21-13"><a href="#cb21-13" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="op">(</span>errno <span class="op">==</span> ECHILD<span class="op">)</span></span>
<span id="cb21-14"><a href="#cb21-14" aria-hidden="true" tabindex="-1"></a>            <span class="cf">break</span><span class="op">;</span></span>
<span id="cb21-15"><a href="#cb21-15" aria-hidden="true" tabindex="-1"></a>        perror<span class="op">(</span><span class="st">&quot;waitpid failed&quot;</span><span class="op">);</span></span>
<span id="cb21-16"><a href="#cb21-16" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb21-17"><a href="#cb21-17" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
</section>
<section id="najistotniejsze-efekty-fork" class="level2">
<h2>Najistotniejsze efekty <code>fork()</code></h2>
<p>Podczas <strong>wywołania systemowego</strong> <code>fork()</code>:</p>
<ul class="incremental">
<li>Używany jest ten dalej ten sam <strong>kod programu</strong></li>
<li>Kopiowany jest <strong>stan procesora</strong> (w tym <strong>wskaźnik aktualnej instrukcji</strong>)</li>
<li>Dziedziczone są <strong>deskryptory plików</strong>:</li>
<li>Kopiowana są <strong>strony pamięci</strong>, ale dopiero po pierwszym zapisie (<strong>Copy-on-write</strong>)</li>
</ul>
</section>
<section id="tworzenie-procesu-który-będzie-wykonywał-inny-program" class="level2">
<h2>Tworzenie procesu, który będzie wykonywał inny program</h2>
<p>Wywołanie <code>fork()</code> powoduje utworzenie nowego procesu, który jest niemalże dokładną kopią procesu potomnego. Żeby zmienić kod wykonywanego programu należy użyc funkcji z rodziny <code>exec()</code></p>
<div class="sourceCode" id="cb22"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb22-1"><a href="#cb22-1" aria-hidden="true" tabindex="-1"></a><span class="dt">int</span> execl<span class="op">(</span><span class="dt">const</span> <span class="dt">char</span> <span class="op">*</span>path<span class="op">,</span></span>
<span id="cb22-2"><a href="#cb22-2" aria-hidden="true" tabindex="-1"></a>          <span class="dt">const</span> <span class="dt">char</span> <span class="op">*</span>arg0<span class="op">,</span> <span class="op">...,</span> <span class="co">/*, (char *)0, */</span><span class="op">);</span></span>
<span id="cb22-3"><a href="#cb22-3" aria-hidden="true" tabindex="-1"></a><span class="dt">int</span> execle<span class="op">(</span><span class="dt">const</span> <span class="dt">char</span> <span class="op">*</span>path<span class="op">,</span></span>
<span id="cb22-4"><a href="#cb22-4" aria-hidden="true" tabindex="-1"></a>           <span class="dt">const</span> <span class="dt">char</span> <span class="op">*</span>arg0<span class="op">,</span> <span class="op">...,</span> <span class="co">/* (char *)0 char *const envp[] */</span><span class="op">);</span></span>
<span id="cb22-5"><a href="#cb22-5" aria-hidden="true" tabindex="-1"></a><span class="dt">int</span> execlp<span class="op">(</span><span class="dt">const</span> <span class="dt">char</span> <span class="op">*</span>file<span class="op">,</span></span>
<span id="cb22-6"><a href="#cb22-6" aria-hidden="true" tabindex="-1"></a>           <span class="dt">const</span> <span class="dt">char</span> <span class="op">*</span>arg0<span class="op">,</span> <span class="op">...,</span> <span class="co">/*, (char *)0, */</span><span class="op">);</span></span>
<span id="cb22-7"><a href="#cb22-7" aria-hidden="true" tabindex="-1"></a><span class="dt">int</span> execv<span class="op">(</span><span class="dt">const</span> <span class="dt">char</span> <span class="op">*</span>path<span class="op">,</span> <span class="dt">char</span> <span class="op">*</span><span class="dt">const</span> argv<span class="op">[]);</span></span>
<span id="cb22-8"><a href="#cb22-8" aria-hidden="true" tabindex="-1"></a><span class="dt">int</span> execvp<span class="op">(</span><span class="dt">const</span> <span class="dt">char</span> <span class="op">*</span>file<span class="op">,</span> <span class="dt">char</span> <span class="op">*</span><span class="dt">const</span> argv<span class="op">[]);</span></span>
<span id="cb22-9"><a href="#cb22-9" aria-hidden="true" tabindex="-1"></a><span class="dt">int</span> execvP<span class="op">(</span><span class="dt">const</span> <span class="dt">char</span> <span class="op">*</span>file<span class="op">,</span> <span class="dt">const</span> <span class="dt">char</span> <span class="op">*</span>search_path<span class="op">,</span></span>
<span id="cb22-10"><a href="#cb22-10" aria-hidden="true" tabindex="-1"></a>          kchar <span class="op">*</span><span class="dt">const</span> argv<span class="op">[]);</span></span></code></pre></div>
<p>Wywołanie systemowe <code>exec()</code> ładuje nowy program do aktualnego procesu (czyli podmienia sekcje .data, .bss, .text, stos i sterte, biblioteki współdzielone)</p>
</section>
<section id="przykład-wykorzystania-exec" class="level2">
<h2>Przykład wykorzystania <code>exec()</code></h2>
<p>Przykładowy program, który utworzy proces potomny i załaduje do niego program <code>ls</code>. Proces rodzica będzie czekał na zakończenie procesu potomnego.</p>
<div class="sourceCode" id="cb23"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb23-1"><a href="#cb23-1" aria-hidden="true" tabindex="-1"></a><span class="dt">int</span> main<span class="op">(</span><span class="dt">int</span> argc<span class="op">,</span> <span class="dt">char</span> <span class="op">**</span>argv<span class="op">)</span></span>
<span id="cb23-2"><a href="#cb23-2" aria-hidden="true" tabindex="-1"></a><span class="op">{</span></span>
<span id="cb23-3"><a href="#cb23-3" aria-hidden="true" tabindex="-1"></a>    <span class="dt">int</span> ret<span class="op">;</span></span>
<span id="cb23-4"><a href="#cb23-4" aria-hidden="true" tabindex="-1"></a>    ret <span class="op">=</span> fork<span class="op">();</span></span>
<span id="cb23-5"><a href="#cb23-5" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="op">(</span>ret <span class="op">==</span> <span class="dv">0</span><span class="op">)</span> <span class="op">{</span></span>
<span id="cb23-6"><a href="#cb23-6" aria-hidden="true" tabindex="-1"></a>        <span class="dt">char</span> <span class="op">*</span>argv<span class="op">[]</span> <span class="op">=</span> <span class="op">{</span> <span class="st">&quot;ls&quot;</span><span class="op">,</span> NULL <span class="op">};</span></span>
<span id="cb23-7"><a href="#cb23-7" aria-hidden="true" tabindex="-1"></a>        ret <span class="op">=</span> execvp<span class="op">(</span><span class="st">&quot;ls&quot;</span><span class="op">,</span> argv<span class="op">);</span></span>
<span id="cb23-8"><a href="#cb23-8" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="op">(</span>ret<span class="op">)</span> <span class="op">{</span></span>
<span id="cb23-9"><a href="#cb23-9" aria-hidden="true" tabindex="-1"></a>            perror<span class="op">(</span><span class="st">&quot;execvp: &quot;</span><span class="op">);</span></span>
<span id="cb23-10"><a href="#cb23-10" aria-hidden="true" tabindex="-1"></a>            <span class="cf">return</span> <span class="dv">1</span><span class="op">;</span></span>
<span id="cb23-11"><a href="#cb23-11" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb23-12"><a href="#cb23-12" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb23-13"><a href="#cb23-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-14"><a href="#cb23-14" aria-hidden="true" tabindex="-1"></a>    wait<span class="op">(</span>NULL<span class="op">);</span></span>
<span id="cb23-15"><a href="#cb23-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-16"><a href="#cb23-16" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> <span class="dv">0</span><span class="op">;</span></span>
<span id="cb23-17"><a href="#cb23-17" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
</section>
<section id="procesy-zombie" class="level2">
<h2>Procesy zombie</h2>
<p>Jeżeli proces zakończył swoje wykonywanie, a rodzic nie wykonał <code>wait()</code> to będzie on nadal widoczny na liście procesów, do momentu wykonania <code>wait()</code> przez rodzica.</p>
<p>Poniższy kod tworzy proces zombie, który będzie istniał około 30 sekund:</p>
<div class="sourceCode" id="cb24"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb24-1"><a href="#cb24-1" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;unistd.h&gt;</span></span>
<span id="cb24-2"><a href="#cb24-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-3"><a href="#cb24-3" aria-hidden="true" tabindex="-1"></a><span class="dt">int</span> main<span class="op">(</span><span class="dt">void</span><span class="op">)</span></span>
<span id="cb24-4"><a href="#cb24-4" aria-hidden="true" tabindex="-1"></a><span class="op">{</span></span>
<span id="cb24-5"><a href="#cb24-5" aria-hidden="true" tabindex="-1"></a>    <span class="co">/* Klonujemy proces */</span></span>
<span id="cb24-6"><a href="#cb24-6" aria-hidden="true" tabindex="-1"></a>    pid_t pid <span class="op">=</span> fork<span class="op">();</span></span>
<span id="cb24-7"><a href="#cb24-7" aria-hidden="true" tabindex="-1"></a>    <span class="co">/* Jeżeli jesteśmy dzieckiem */</span></span>
<span id="cb24-8"><a href="#cb24-8" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="op">(</span>pid <span class="op">==</span> <span class="dv">0</span><span class="op">)</span></span>
<span id="cb24-9"><a href="#cb24-9" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="dv">0</span><span class="op">;</span> <span class="co">/* Kończymy - proces jest zombie do wykonania wait() */</span></span>
<span id="cb24-10"><a href="#cb24-10" aria-hidden="true" tabindex="-1"></a>    <span class="co">/* Jeżeli jesteśmy rodzicem to czekamy 30 sekund*/</span></span>
<span id="cb24-11"><a href="#cb24-11" aria-hidden="true" tabindex="-1"></a>    sleep<span class="op">(</span><span class="dv">30</span><span class="op">);</span></span>
<span id="cb24-12"><a href="#cb24-12" aria-hidden="true" tabindex="-1"></a>    <span class="co">/* Odczytujemy kod wyjścia procesu i usuwamy go z listy procesów */</span></span>
<span id="cb24-13"><a href="#cb24-13" aria-hidden="true" tabindex="-1"></a>    wait<span class="op">(</span>NULL<span class="op">);</span></span>
<span id="cb24-14"><a href="#cb24-14" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> <span class="dv">0</span><span class="op">;</span></span>
<span id="cb24-15"><a href="#cb24-15" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
</section>
<section id="pytanie" class="level2">
<h2>Pytanie</h2>
<p>Jeżeli nie wywołamy <code>wait()</code>, to dlaczego dziecko znika po zakończeniu rodzica?</p>
<div class="sourceCode" id="cb25"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb25-1"><a href="#cb25-1" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;unistd.h&gt;</span></span>
<span id="cb25-2"><a href="#cb25-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-3"><a href="#cb25-3" aria-hidden="true" tabindex="-1"></a><span class="dt">int</span> main<span class="op">(</span><span class="dt">void</span><span class="op">)</span></span>
<span id="cb25-4"><a href="#cb25-4" aria-hidden="true" tabindex="-1"></a><span class="op">{</span></span>
<span id="cb25-5"><a href="#cb25-5" aria-hidden="true" tabindex="-1"></a>    pid_t pid <span class="op">=</span> fork<span class="op">();</span></span>
<span id="cb25-6"><a href="#cb25-6" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="op">(</span>pid <span class="op">==</span> <span class="dv">0</span><span class="op">)</span></span>
<span id="cb25-7"><a href="#cb25-7" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="dv">0</span><span class="op">;</span></span>
<span id="cb25-8"><a href="#cb25-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-9"><a href="#cb25-9" aria-hidden="true" tabindex="-1"></a>    <span class="co">/* Nie wywołujemy tutaj wywołania systemowego wait(), więc nie zakończymy</span></span>
<span id="cb25-10"><a href="#cb25-10" aria-hidden="true" tabindex="-1"></a><span class="co">       dziecka */</span></span>
<span id="cb25-11"><a href="#cb25-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-12"><a href="#cb25-12" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> <span class="dv">0</span><span class="op">;</span></span>
<span id="cb25-13"><a href="#cb25-13" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
</section>
<section id="odpowiedź" class="level2">
<h2>Odpowiedź</h2>
<p>Każdy osierocony proces jest adoptowany przez główny proces (<code>systemd</code> albo <code>init</code>).</p>
<pre class="console"><code>$ pstree
systemd─┬─ModemManager─── ...
        ├─NetworkManager─── ...
        ├─fwupd───4*[{fwupd}]
        ├─gdm3─┬─gdm-session-wor─┬─gdm-x-session─┬─Xorg───{Xorg}
        │      │                 │               ├─gnome-session-b─┬─ssh-agent
        │      │                 │               │                 └─2*[{gnome-session-b}]
        │      │                 │               └─2*[{gdm-x-session}]
        │      │                 └─2*[{gdm-session-wor}]
        │      └─2*[{gdm3}]
        ├─ X
       ... ^
           |
           &#39;---- tu zostanie zaadoptowany osierocony proces</code></pre>
<p>Następnie <code>systemd</code> lub <code>init</code> wywoła na nim <code>wait()</code>.</p>
</section>
<section id="zagadka-0" class="level2">
<h2>Zagadka 0</h2>
<p>Ile procesów zostanie utworzonych w poniższym programie?</p>
<div class="sourceCode" id="cb27"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb27-1"><a href="#cb27-1" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;unistd.h&gt;</span></span>
<span id="cb27-2"><a href="#cb27-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb27-3"><a href="#cb27-3" aria-hidden="true" tabindex="-1"></a><span class="dt">int</span> main<span class="op">(</span><span class="dt">void</span><span class="op">)</span></span>
<span id="cb27-4"><a href="#cb27-4" aria-hidden="true" tabindex="-1"></a><span class="op">{</span></span>
<span id="cb27-5"><a href="#cb27-5" aria-hidden="true" tabindex="-1"></a>    fork<span class="op">();</span></span>
<span id="cb27-6"><a href="#cb27-6" aria-hidden="true" tabindex="-1"></a>    fork<span class="op">();</span></span>
<span id="cb27-7"><a href="#cb27-7" aria-hidden="true" tabindex="-1"></a>    fork<span class="op">();</span></span>
<span id="cb27-8"><a href="#cb27-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb27-9"><a href="#cb27-9" aria-hidden="true" tabindex="-1"></a>    fork<span class="op">();</span></span>
<span id="cb27-10"><a href="#cb27-10" aria-hidden="true" tabindex="-1"></a>    fork<span class="op">();</span></span>
<span id="cb27-11"><a href="#cb27-11" aria-hidden="true" tabindex="-1"></a>    fork<span class="op">();</span></span>
<span id="cb27-12"><a href="#cb27-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb27-13"><a href="#cb27-13" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> <span class="dv">0</span><span class="op">;</span></span>
<span id="cb27-14"><a href="#cb27-14" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
</section>
<section id="zagadka-1" class="level2">
<h2>Zagadka 1</h2>
<p>Ile procesów zostanie utworzonych w poniższym programie?</p>
<div class="sourceCode" id="cb28"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb28-1"><a href="#cb28-1" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;unistd.h&gt;</span></span>
<span id="cb28-2"><a href="#cb28-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-3"><a href="#cb28-3" aria-hidden="true" tabindex="-1"></a><span class="dt">int</span> main<span class="op">(</span><span class="dt">void</span><span class="op">)</span></span>
<span id="cb28-4"><a href="#cb28-4" aria-hidden="true" tabindex="-1"></a><span class="op">{</span></span>
<span id="cb28-5"><a href="#cb28-5" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> <span class="op">(</span><span class="dt">int</span> i <span class="op">=</span> <span class="dv">0</span><span class="op">;</span> i <span class="op">&lt;</span> <span class="dv">10</span><span class="op">;</span> <span class="op">++</span>i<span class="op">)</span></span>
<span id="cb28-6"><a href="#cb28-6" aria-hidden="true" tabindex="-1"></a>        fork<span class="op">();</span></span>
<span id="cb28-7"><a href="#cb28-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-8"><a href="#cb28-8" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> <span class="dv">0</span><span class="op">;</span></span>
<span id="cb28-9"><a href="#cb28-9" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
</section>
<section id="zagadka-2" class="level2">
<h2>Zagadka 2</h2>
<p>Ile procesów zostanie utworzonych w poniższym programie?</p>
<div class="sourceCode" id="cb29"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb29-1"><a href="#cb29-1" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;unistd.h&gt;</span></span>
<span id="cb29-2"><a href="#cb29-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-3"><a href="#cb29-3" aria-hidden="true" tabindex="-1"></a><span class="dt">int</span> main<span class="op">(</span><span class="dt">void</span><span class="op">)</span></span>
<span id="cb29-4"><a href="#cb29-4" aria-hidden="true" tabindex="-1"></a><span class="op">{</span></span>
<span id="cb29-5"><a href="#cb29-5" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> <span class="op">(</span><span class="dt">int</span> i <span class="op">=</span> <span class="dv">0</span><span class="op">;</span> i <span class="op">&lt;</span> <span class="dv">10</span><span class="op">;</span> <span class="op">++</span>i<span class="op">)</span> <span class="op">{</span></span>
<span id="cb29-6"><a href="#cb29-6" aria-hidden="true" tabindex="-1"></a>        fork<span class="op">();</span></span>
<span id="cb29-7"><a href="#cb29-7" aria-hidden="true" tabindex="-1"></a>        execlp<span class="op">(</span><span class="st">&quot;ls&quot;</span><span class="op">,</span> <span class="st">&quot;ls&quot;</span><span class="op">,</span> NULL<span class="op">);</span></span>
<span id="cb29-8"><a href="#cb29-8" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb29-9"><a href="#cb29-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-10"><a href="#cb29-10" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> <span class="dv">0</span><span class="op">;</span></span>
<span id="cb29-11"><a href="#cb29-11" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
</section>
</section>
<section id="planista" class="level1">
<h1>Planista</h1>
<section id="planista-w-systemie-linux" class="level2">
<h2>Planista w systemie Linux</h2>
<p>Decydowaniem, który proces zostanie uruchomiony jako następny zajmuje się planista (ang. scheduler).</p>
<p>Zadaniem planisty jest dbanie o podział czasu procesora według ustalonych celów.</p>
<p>Planista w systemie Linux to <strong>Całkowicie Sprawiedliwy Planista</strong> (ang. Completely Fair Scheduler, CFS)</p>
<p>Dba on o to aby każdy proces otrzymał sprawiedliwą część czasu procesora.</p>
<p>Za każdym razem uruchamia ten process który otrzymał do tej pory najmniej czasu, w stosunku do należnej części.</p>
</section>
<section id="jak-planista-reprezentuje-procesy" class="level2">
<h2>Jak planista reprezentuje procesy</h2>
<p>W systemie Linux każdy proces, jest reprezentowany przez strukturę <code>struct task_struct</code></p>
<p>Oto jej ważniejsze pola:</p>
<div class="sourceCode" id="cb30"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb30-1"><a href="#cb30-1" aria-hidden="true" tabindex="-1"></a><span class="kw">struct</span> task_struct <span class="op">{</span></span>
<span id="cb30-2"><a href="#cb30-2" aria-hidden="true" tabindex="-1"></a>    <span class="kw">struct</span> list_head tasks           <span class="co">/* Wpis na liscie procesów */</span></span>
<span id="cb30-3"><a href="#cb30-3" aria-hidden="true" tabindex="-1"></a>    pid_t pid<span class="op">;</span>                       <span class="co">/* Identyfikator procesu */</span></span>
<span id="cb30-4"><a href="#cb30-4" aria-hidden="true" tabindex="-1"></a>    <span class="kw">struct</span> mm_struct <span class="op">*</span>mm             <span class="co">/* Przestrzeń adresowa */</span></span>
<span id="cb30-5"><a href="#cb30-5" aria-hidden="true" tabindex="-1"></a>    <span class="kw">struct</span> task_struct <span class="op">*</span>real_parent<span class="op">;</span> <span class="co">/* Prawdziwy rodzic - ten kto wywołał clone() */</span></span>
<span id="cb30-6"><a href="#cb30-6" aria-hidden="true" tabindex="-1"></a>    <span class="kw">struct</span> task_struct <span class="op">*</span>parent<span class="op">;</span>      <span class="co">/* Odbiorca SIGCHLD i wait4() */</span></span>
<span id="cb30-7"><a href="#cb30-7" aria-hidden="true" tabindex="-1"></a>    <span class="kw">struct</span> list_head children<span class="op">;</span>       <span class="co">/* Dzieci procesu */</span></span>
<span id="cb30-8"><a href="#cb30-8" aria-hidden="true" tabindex="-1"></a>    <span class="kw">struct</span> sigpending pending<span class="op">;</span>       <span class="co">/* Lista oczekujących sygnałów */</span></span>
<span id="cb30-9"><a href="#cb30-9" aria-hidden="true" tabindex="-1"></a>    <span class="kw">struct</span> files_struct <span class="op">*</span>files<span class="op">;</span>      <span class="co">/* Otwarte deskryptory plików */</span></span>
<span id="cb30-10"><a href="#cb30-10" aria-hidden="true" tabindex="-1"></a>    <span class="dt">void</span> <span class="op">*</span>stack                      <span class="co">/* Wskaznik do stosu jądra dla tego</span></span>
<span id="cb30-11"><a href="#cb30-11" aria-hidden="true" tabindex="-1"></a><span class="co">                                        procesu - tu są zapisane rejestry */</span></span>
<span id="cb30-12"><a href="#cb30-12" aria-hidden="true" tabindex="-1"></a>    <span class="op">...</span></span>
<span id="cb30-13"><a href="#cb30-13" aria-hidden="true" tabindex="-1"></a><span class="op">};</span></span></code></pre></div>
</section>
<section id="lista-procesów" class="level2">
<h2>Lista procesów</h2>
<p>System operacyjny przechowuje procesy na liście dwukierunkowej.</p>
<p><img src="assets/12.svg" /></p>
</section>
<section id="jak-cfs-przydziela-czas-procesora" class="level2">
<h2>Jak CFS przydziela czas procesora</h2>
<p>Długości odcinków czasowych są wyliczane dynamicznie, na podstawie docelowego opóźnienia (ang. target latency) i priorytetu procesu (niceness i priority), dzięki czemu podział czasu procesora jest zawsze sprawiedliwy.</p>
<p><img src="assets/10.svg" /></p>
</section>
<section id="preemptive-vs-cooperative-multitasking" class="level2">
<h2>Preemptive vs Cooperative multitasking</h2>
<p>W przypadku preemptive multitasking planista może wywłaszczyć proces w dowolnym momencie, w przypadku cooperative - tylko w wyznaczonym przez proces momencie. <strong>Planista w Linuksie implementuje preemptive multitasking.</strong></p>
<p><img src="assets/11.svg" /></p>
</section>
<section id="kiedy-następuje-wywłaszczenie" class="level2">
<h2>Kiedy następuje wywłaszczenie</h2>
<p>CFS może zaplanować wykonywanie innego procesu w momencie wystąpienia przerwania:</p>
<p>Czyli na przykład w momencie:</p>
<ul class="incremental">
<li>naciśnięcia klawisza, odebrania pakietu sieciowego czy innego zdarzenia sprzętowego;</li>
<li>przerwania pochodzącego od czasomierza systemowego (Programmable System Timer);</li>
<li>wywołania systemowego (np. <code>open()</code>, <code>fork()</code>, <code>sleep()</code>, <code>write()</code>).</li>
</ul>
<div class="sourceCode" id="cb31"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb31-1"><a href="#cb31-1" aria-hidden="true" tabindex="-1"></a><span class="dt">int</span> main<span class="op">(</span><span class="dt">void</span><span class="op">)</span></span>
<span id="cb31-2"><a href="#cb31-2" aria-hidden="true" tabindex="-1"></a><span class="op">{</span></span>
<span id="cb31-3"><a href="#cb31-3" aria-hidden="true" tabindex="-1"></a>    <span class="dt">int</span> x<span class="op">,</span> w<span class="op">;</span></span>
<span id="cb31-4"><a href="#cb31-4" aria-hidden="true" tabindex="-1"></a>    x <span class="op">=</span> <span class="dv">1</span><span class="op">;</span>                               <span class="op">&lt;----</span> tu może wystąpić przerwanie<span class="op">,</span> możliwa zmiana procesu</span>
<span id="cb31-5"><a href="#cb31-5" aria-hidden="true" tabindex="-1"></a>    printf<span class="op">(</span><span class="st">&quot;</span><span class="sc">%d\n</span><span class="st">&quot;</span><span class="op">,</span> x<span class="op">);</span>                   <span class="op">&lt;----</span> wywołanie systemowe write<span class="op">(),</span> możliwa zmiana procesu</span>
<span id="cb31-6"><a href="#cb31-6" aria-hidden="true" tabindex="-1"></a>    <span class="dt">int</span> fd <span class="op">=</span> open<span class="op">(</span><span class="st">&quot;plik.txt&quot;</span><span class="op">,</span> O_RDONLY<span class="op">);</span> <span class="op">&lt;----</span> wywołanie systemowe open<span class="op">(),</span> możliwa zmiana procesu</span>
<span id="cb31-7"><a href="#cb31-7" aria-hidden="true" tabindex="-1"></a>    w <span class="op">=</span> x <span class="op">+</span> <span class="dv">1</span><span class="op">;</span>                           <span class="op">&lt;----</span> tu może wystąpić przerwanie<span class="op">,</span> możliwa zmiana procesu</span>
<span id="cb31-8"><a href="#cb31-8" aria-hidden="true" tabindex="-1"></a>    <span class="dt">int</span> <span class="op">*</span>g <span class="op">=</span> malloc<span class="op">(</span><span class="kw">sizeof</span><span class="op">(*</span>g<span class="op">));</span>         <span class="op">&lt;----</span> malloc<span class="op">()</span> nie jest wywołaniem systemowym ale</span>
<span id="cb31-9"><a href="#cb31-9" aria-hidden="true" tabindex="-1"></a>                                               może wywołać brk<span class="op">(),</span> sbrk<span class="op">(),</span> mmap<span class="op">(),</span> które są<span class="op">,</span></span>
<span id="cb31-10"><a href="#cb31-10" aria-hidden="true" tabindex="-1"></a>                                               czyli możliwa zmiana procesu</span>
<span id="cb31-11"><a href="#cb31-11" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
</section>
</section>
<section id="pamięć-procesu" class="level1">
<h1>Pamięć procesu</h1>
<section id="zmienne-reprezentują-komórki-pamięci" class="level2">
<h2>Zmienne reprezentują komórki pamięci</h2>
<p>Każda zmienna reprezentuje pewną komórkę pamięci.</p>
<div class="sourceCode" id="cb32"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb32-1"><a href="#cb32-1" aria-hidden="true" tabindex="-1"></a><span class="dt">int</span> y <span class="op">=</span> <span class="dv">2</span><span class="op">;</span> <span class="co">/* Zmienna w sekcji .data */</span></span>
<span id="cb32-2"><a href="#cb32-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-3"><a href="#cb32-3" aria-hidden="true" tabindex="-1"></a><span class="dt">int</span> main<span class="op">(</span><span class="dt">void</span><span class="op">)</span></span>
<span id="cb32-4"><a href="#cb32-4" aria-hidden="true" tabindex="-1"></a><span class="op">{</span></span>
<span id="cb32-5"><a href="#cb32-5" aria-hidden="true" tabindex="-1"></a>    <span class="dt">int</span> x<span class="op">;</span> <span class="co">/* Zmienna na stosie */</span></span>
<span id="cb32-6"><a href="#cb32-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-7"><a href="#cb32-7" aria-hidden="true" tabindex="-1"></a>    printf<span class="op">(</span><span class="st">&quot;</span><span class="sc">%p\n</span><span class="st">&quot;</span><span class="op">,</span> <span class="op">&amp;</span>x<span class="op">);</span></span>
<span id="cb32-8"><a href="#cb32-8" aria-hidden="true" tabindex="-1"></a>    printf<span class="op">(</span><span class="st">&quot;</span><span class="sc">%p\n</span><span class="st">&quot;</span><span class="op">,</span> <span class="op">&amp;</span>y<span class="op">);</span></span>
<span id="cb32-9"><a href="#cb32-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-10"><a href="#cb32-10" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> <span class="dv">0</span><span class="op">;</span></span>
<span id="cb32-11"><a href="#cb32-11" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
</section>
<section id="pamięć-wirtualna" class="level2">
<h2>Pamięć wirtualna</h2>
<p>Proces operuje na wirtualnych adresach pamięci, które są mapowane do fizycznych adresów, przez tabele stron. Instruuje ona jednostkę zarządzania pamięcią (ang. Memory Management Unit) w jaki sposób ma mapować pamięć.</p>
<p><img src="assets/1.svg" /></p>
</section>
<section id="sekcje-pamięci" class="level2">
<h2>Sekcje pamięci</h2>
<p>W systemie Linux skompilowany program będzie miał odpowiednią strukturę w pamięci:</p>
<div class="sourceCode" id="cb33"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb33-1"><a href="#cb33-1" aria-hidden="true" tabindex="-1"></a><span class="dt">int</span> x<span class="op">;</span>  <span class="co">/* Niezainicjalizowane dane (.bss) */</span></span>
<span id="cb33-2"><a href="#cb33-2" aria-hidden="true" tabindex="-1"></a><span class="dt">int</span> y <span class="op">=</span> <span class="dv">3</span><span class="op">;</span> <span class="co">/* Zainicjalizowane dane (.data) */</span></span>
<span id="cb33-3"><a href="#cb33-3" aria-hidden="true" tabindex="-1"></a><span class="dt">void</span> foo<span class="op">(</span><span class="dt">int</span> x<span class="op">)</span> <span class="co">/* Argumenty w rejestrach lub na stosie */</span>     <span class="op">---.</span></span>
<span id="cb33-4"><a href="#cb33-4" aria-hidden="true" tabindex="-1"></a><span class="op">{</span>                                                                 <span class="op">|</span></span>
<span id="cb33-5"><a href="#cb33-5" aria-hidden="true" tabindex="-1"></a>    <span class="dt">static</span> <span class="dt">int</span> x<span class="op">;</span> <span class="co">/* Niezainicjalizowane dane (.bss) */</span>           <span class="op">|</span></span>
<span id="cb33-6"><a href="#cb33-6" aria-hidden="true" tabindex="-1"></a>    <span class="dt">static</span> <span class="dt">int</span> y <span class="op">=</span> <span class="dv">4</span><span class="op">;</span> <span class="co">/* Zainicjalizowane dane (.data) */</span>         <span class="op">|</span></span>
<span id="cb33-7"><a href="#cb33-7" aria-hidden="true" tabindex="-1"></a><span class="op">}</span>                                                                 <span class="op">|</span></span>
<span id="cb33-8"><a href="#cb33-8" aria-hidden="true" tabindex="-1"></a><span class="dt">int</span> main<span class="op">(</span><span class="dt">void</span><span class="op">)</span>                                                    <span class="op">|</span>    kod</span>
<span id="cb33-9"><a href="#cb33-9" aria-hidden="true" tabindex="-1"></a><span class="op">{</span>                                                                 <span class="op">|</span>___ programu</span>
<span id="cb33-10"><a href="#cb33-10" aria-hidden="true" tabindex="-1"></a>    <span class="dt">int</span> x<span class="op">;</span> <span class="co">/* Alokacja na stosie */</span>                               <span class="op">|</span>    umieszczany</span>
<span id="cb33-11"><a href="#cb33-11" aria-hidden="true" tabindex="-1"></a>    <span class="dt">int</span> <span class="op">*</span>y <span class="op">=</span> malloc<span class="op">(</span><span class="dv">1024</span><span class="op">);</span> <span class="co">/* Wskaźnik na stosie, */</span>              <span class="op">|</span>    w sekcji <span class="op">.</span>text</span>
<span id="cb33-12"><a href="#cb33-12" aria-hidden="true" tabindex="-1"></a>                           <span class="co">/* a blok pamięci na stercie */</span>        <span class="op">|</span></span>
<span id="cb33-13"><a href="#cb33-13" aria-hidden="true" tabindex="-1"></a>    foo<span class="op">(</span><span class="dv">1</span><span class="op">);</span> <span class="co">/* Adres powrotu na stosie,                           |</span></span>
<span id="cb33-14"><a href="#cb33-14" aria-hidden="true" tabindex="-1"></a><span class="co">               argumenty w rejestrach lub na stosie  */</span>           <span class="op">|</span></span>
<span id="cb33-15"><a href="#cb33-15" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> <span class="dv">0</span><span class="op">;</span>                                                     <span class="op">|</span></span>
<span id="cb33-16"><a href="#cb33-16" aria-hidden="true" tabindex="-1"></a><span class="op">}</span>                                                              <span class="op">---</span><span class="ch">&#39;</span></span></code></pre></div>
</section>
<section id="sekcje-pamięci-procesu" class="level2">
<h2>Sekcje pamięci procesu</h2>
<p>Pamięć procesu podzielona jest na sekcje, w których znajdują się “podobnego” rodzaju dane.</p>
<p><img src="assets/2.svg" /></p>
</section>
<section id="przykład-sekcji-pamięci---proces-yes" class="level2">
<h2>Przykład sekcji pamięci - proces <code>yes</code></h2>
<pre class="console"><code>$ cat /proc/39299/maps
56148e969000-56148e96b000 r--p 00000000 08:05 24118661   /usr/bin/yes
56148e96b000-56148e96f000 r-xp 00002000 08:05 24118661   /usr/bin/yes
56148e96f000-56148e971000 r--p 00006000 08:05 24118661   /usr/bin/yes
56148e972000-56148e973000 r--p 00008000 08:05 24118661   /usr/bin/yes
56148e973000-56148e974000 rw-p 00009000 08:05 24118661   /usr/bin/yes
56148f694000-56148f6b5000 rw-p 00000000 00:00 0          [heap]
7f9f89876000-7f9f8a8cc000 r--p 00000000 08:05 24117276   /usr/lib/locale/locale-archive
7f9f8a8cc000-7f9f8a8ee000 r--p 00000000 08:05 24122481   /usr/lib/x86_64-linux-gnu/libc-2.31.so
7f9f8a8ee000-7f9f8aa66000 r-xp 00022000 08:05 24122481   /usr/lib/x86_64-linux-gnu/libc-2.31.so
7f9f8aa66000-7f9f8aab4000 r--p 0019a000 08:05 24122481   /usr/lib/x86_64-linux-gnu/libc-2.31.so
7f9f8aab4000-7f9f8aab8000 r--p 001e7000 08:05 24122481   /usr/lib/x86_64-linux-gnu/libc-2.31.so
7f9f8aab8000-7f9f8aaba000 rw-p 001eb000 08:05 24122481   /usr/lib/x86_64-linux-gnu/libc-2.31.so
7f9f8aaba000-7f9f8aac0000 rw-p 00000000 00:00 0
7f9f8aae0000-7f9f8aae1000 r--p 00000000 08:05 24122477   /usr/lib/x86_64-linux-gnu/ld-2.31.so
7f9f8aae1000-7f9f8ab04000 r-xp 00001000 08:05 24122477   /usr/lib/x86_64-linux-gnu/ld-2.31.so
7f9f8ab04000-7f9f8ab0c000 r--p 00024000 08:05 24122477   /usr/lib/x86_64-linux-gnu/ld-2.31.so
7f9f8ab0d000-7f9f8ab0e000 r--p 0002c000 08:05 24122477   /usr/lib/x86_64-linux-gnu/ld-2.31.so
7f9f8ab0e000-7f9f8ab0f000 rw-p 0002d000 08:05 24122477   /usr/lib/x86_64-linux-gnu/ld-2.31.so
7f9f8ab0f000-7f9f8ab10000 rw-p 00000000 00:00 0
7ffe6a478000-7ffe6a499000 rw-p 00000000 00:00 0          [stack]
7ffe6a5cb000-7ffe6a5cf000 r--p 00000000 00:00 0          [vvar]
7ffe6a5cf000-7ffe6a5d1000 r-xp 00000000 00:00 0          [vdso]
ffffffffff600000-ffffffffff601000 --xp 00000000 00:00 0  [vsyscall]</code></pre>
</section>
<section id="address-space-layout-randomization" class="level2">
<h2>Address space layout randomization</h2>
<p>Adresy sekcji są losowe, aby utrudnić manipulacje na pamięci atakującemu.</p>
<p><img src="assets/3.svg" /></p>
</section>
<section id="kaslr" class="level2">
<h2>KASLR</h2>
<p>Jądro jest mapowane pod losowym adresem</p>
<p><img src="assets/4.svg" /></p>
</section>
<section id="kaiser" class="level2">
<h2>KAISER</h2>
<p>Mapowana jest tylko niezbędna część jądra. Po przełączeniu się w tryb jądra (przy wywołaniach systemowych) tabela stron jest przełączana na pełną wersję (zmiana rejestru CR3).</p>
<p><img src="assets/5.svg" /></p>
</section>
<section id="copy-on-write" class="level2">
<h2>Copy-on-write</h2>
<p>Strony pamięci wirtualnej nowego procesu oznaczone są jako tylko do odczytu. Próba nadpisania skutkuje wyjątkiem Page Fault, którego obsługa pozwala systemowi operacyjnemu skopiować stronę</p>
<p><img src="assets/0.svg" /></p>
</section>
</section>
<section id="dziękuję-za-uwagę" class="level1">
<h1>Dziękuję za uwagę</h1>
<section id="dalsza-lektura" class="level2">
<h2>Dalsza lektura</h2>
<ul class="incremental">
<li><strong>Książki</strong>
<ul class="incremental">
<li>Love Robert. 2010. Linux Kernel Development. Pearson Education.</li>
<li>Love Robert. 2013. Linux System Programming. O’REILLY.</li>
<li>Stevens Richard W., Rago Stephen A., Advanced Programming in the UNIX® Environment, Third Edition. Addison-Wesley.</li>
</ul></li>
<li><strong>Artykuły</strong>
<ul class="incremental">
<li>https://lwn.net/Articles/738975/</li>
<li>https://samwho.dev/blog/context-switching-on-x86/</li>
</ul></li>
<li><strong>Manual</strong>
<ul class="incremental">
<li><code>man 2 fork</code></li>
<li><code>man 2 wait</code></li>
<li><code>man 3 exec</code></li>
</ul></li>
</ul>
</section>
</section>
  <script>
    /*!	
    * FitText.js 1.0 jQuery free version
    *
    * Copyright 2011, Dave Rupert http://daverupert.com 
    * Released under the WTFPL license 
    * http://sam.zoy.org/wtfpl/
    * Modified by Slawomir Kolodziej http://slawekk.info
    *
    * Date: Tue Aug 09 2011 10:45:54 GMT+0200 (CEST)
    */
    (function(){

      var addEvent = function (el, type, fn) {
        if (el.addEventListener)
          el.addEventListener(type, fn, false);
            else
                el.attachEvent('on'+type, fn);
      };
      
      var extend = function(obj,ext){
        for(var key in ext)
          if(ext.hasOwnProperty(key))
            obj[key] = ext[key];
        return obj;
      };

      window.fitText = function (el, kompressor, options) {

        var settings = extend({
          'minFontSize' : -1/0,
          'maxFontSize' : 1/0
        },options);

        var fit = function (el) {
          var compressor = kompressor || 1;

          var resizer = function () {
            el.style.fontSize = Math.max(Math.min(el.clientWidth / (compressor*10), parseFloat(settings.maxFontSize)), parseFloat(settings.minFontSize)) + 'px';
          };

          // Call once to set.
          resizer();

          // Bind events
          // If you have any js library which support Events, replace this part
          // and remove addEvent function (or use original jQuery version)
          addEvent(window, 'resize', resizer);
          addEvent(window, 'orientationchange', resizer);
        };

        if (el.length)
          for(var i=0; i<el.length; i++)
            fit(el[i]);
        else
          fit(el);

        // return set of elements
        return el;
      };
    })();

    fitText(document.querySelectorAll('.level2'), 5);
    fitText(document.querySelectorAll('h1'), 2.5);

    document.querySelectorAll('p > img').forEach(e => e.parentNode.style.overflow="hidden");

  </script>
  </body>
</html>
